import React, { useState, useEffect } from "react";
import { useNavigate, useParams } from "react-router-dom";
import { useSelector } from "react-redux";
import type { RootState } from "../../../store";
import apiClient from "../../../api/client";
import {
  Box,
  Container,
  Paper,
  Typography,
  Stepper,
  Step,
  StepLabel,
  Button,
  TextField,
  FormControl,
  InputLabel,
  Select,
  MenuItem,
  FormControlLabel,
  Checkbox,
  Alert,
  InputAdornment,
  Card,
  CardContent,
  Autocomplete,
  CircularProgress,
  IconButton,
  Dialog,
  DialogTitle,
  DialogContent,
  DialogActions,
} from "@mui/material";
import {
  ArrowForward,
  ArrowBack,
  CloudUpload,
  Close,
  Person,
  LocationOn,
  AttachMoney,
  Umbrella,
  DateRange,
  VideoLibrary,
  PlayArrow,
} from "@mui/icons-material";
import SuccessModal from "../../common/SuccessModal";

// √áatƒ± Perde Sistemi T√ºrleri
const CATI_PERDE_SISTEMLERI = [
  "Hƒ±zlƒ± Kayar Perde",
  "Sabit Tente",
  "Tulum Kayar Perde",
  "Yana Kayar Perde",
  "Tavana Sabit Yana Kayar Perde",
];

interface PilotFormData {
  // Genel Bilgiler
  title: string;
  description: string;
  year: number;
  price: string;

  // Brand/Model/Variant
  categoryId: string;
  brandId: string;
  modelId: string;
  variantId: string;

  // Teknik √ñzellikler
  uzunluk: number;
  lastikDurumu: number;
  catiPerdeSistemi: string;

  // Konum
  cityId: string;
  districtId: string;

  // Fotoƒüraflar
  photos: File[];
  showcasePhoto: File | null;

  // Video
  videos: File[];

  // Ekstra
  warranty: boolean;
  negotiable: boolean;
  exchange: boolean;

  detailedInfo: string;

  // ƒ∞leti≈üim bilgileri
  sellerName?: string;
  sellerPhone?: string;
  sellerEmail?: string;
  city?: string;
  district?: string;
}

interface City {
  id: number;
  name: string;
  plateCode: string;
}

interface District {
  id: number;
  name: string;
  cityId: number;
}

interface Brand {
  id: number;
  name: string;
  slug: string;
}

interface Model {
  id: number;
  name: string;
  slug: string;
  brandId: number;
}

interface Variant {
  id: number;
  name: string;
  slug: string;
  modelId: number;
}

const steps = ["ƒ∞lan Detaylarƒ±", "Fotoƒüraflar", "ƒ∞leti≈üim & Fiyat"];

const PilotForm: React.FC = () => {
  const navigate = useNavigate();
  const { brandSlug, modelSlug, variantSlug } = useParams<{
    brandSlug: string;
    modelSlug: string;
    variantSlug: string;
  }>();
  // Get user from Redux store
  const user = useSelector((state: RootState) => state.auth?.user) || null;

  const [activeStep, setActiveStep] = useState(0);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [cities, setCities] = useState<City[]>([]);
  const [districts, setDistricts] = useState<District[]>([]);
  const [loadingCities, setLoadingCities] = useState(false);
  const [loadingDistricts, setLoadingDistricts] = useState(false);
  const [images, setImages] = useState<File[]>([]);
  const [showcaseImageIndex, setShowcaseImageIndex] = useState(0);
  const [showSuccessModal, setShowSuccessModal] = useState(false);
  const [createdAdId, setCreatedAdId] = useState<string | null>(null);

  // Video states
  const [videoPreviews, setVideoPreviews] = useState<string[]>([]);
  const [videoModalOpen, setVideoModalOpen] = useState(false);
  const [currentVideoIndex, setCurrentVideoIndex] = useState(0);

  // Brand/Model/Variant states
  const [brands, setBrands] = useState<Brand[]>([]);
  const [models, setModels] = useState<Model[]>([]);
  const [variants, setVariants] = useState<Variant[]>([]);
  const [, setLoadingBrands] = useState(false);
  const [, setLoadingModels] = useState(false);
  const [, setLoadingVariants] = useState(false);

  const [formData, setFormData] = useState<PilotFormData>({
    title: "",
    description: "",
    year: new Date().getFullYear(),
    price: "",
    categoryId: "6", // Dorse category ID
    brandId: "",
    modelId: "",
    variantId: variantSlug || "",
    uzunluk: 0,
    lastikDurumu: 100,
    catiPerdeSistemi: "",
    cityId: "",
    districtId: "",
    photos: [],
    showcasePhoto: null,
    videos: [],
    warranty: false,
    negotiable: false,
    exchange: false,
    detailedInfo: "",
    sellerName: "",
    sellerPhone: "",
    sellerEmail: "",
    city: "",
    district: "",
  });

  // Video upload handler
  const handleVideoUpload = (e: React.ChangeEvent<HTMLInputElement>) => {
    const files = e.target.files;
    if (files) {
      const videoFiles = Array.from(files).filter((file) =>
        file.type.startsWith("video/")
      );

      if (videoFiles.length > 0) {
        const totalVideos = formData.videos.length + videoFiles.length;
        if (totalVideos > 5) {
          alert("En fazla 5 video y√ºkleyebilirsiniz.");
          return;
        }

        videoFiles.forEach((file) => {
          if (file.size > 50 * 1024 * 1024) {
            alert(`${file.name} dosyasƒ± 50MB'dan b√ºy√ºk olamaz.`);
            return;
          }

          const reader = new FileReader();
          reader.onload = (e) => {
            const videoUrl = e.target?.result as string;

            setFormData((prev) => ({
              ...prev,
              videos: [...prev.videos, file],
            }));

            setVideoPreviews((prev) => [...prev, videoUrl]);
          };
          reader.readAsDataURL(file);
        });
      }
    }
  };

  const removeVideo = (index: number) => {
    setFormData((prev) => ({
      ...prev,
      videos: prev.videos.filter((_, i) => i !== index),
    }));
    setVideoPreviews((prev) => prev.filter((_, i) => i !== index));
  };

  const openVideoModal = (index: number) => {
    setCurrentVideoIndex(index);
    setVideoModalOpen(true);
  };

  // Auto-load category ID - Dorse category ID (integer)
  useEffect(() => {
    setFormData((prev) => ({
      ...prev,
      categoryId: "6", // Dorse category ID
    }));
  }, []);

  // Auto-load brand/model/variant from URL slugs
  useEffect(() => {
    const loadFromSlugs = async () => {
      console.log("üîÑ PilotForm Loading from URL slugs:", {
        brandSlug,
        modelSlug,
        variantSlug,
      });
      try {
        if (brandSlug) {
          console.log(`üîç Looking for brand: ${brandSlug}`);
          setLoadingBrands(true);
          const response = await apiClient.get("/brands");
          const allBrands = response.data as Brand[];
          setBrands(allBrands);

          const selectedBrand = allBrands.find(
            (b: Brand) => b.slug === brandSlug
          );
          if (selectedBrand) {
            console.log(
              `‚úÖ Brand found: ${selectedBrand.name} (ID: ${selectedBrand.id})`
            );
            setFormData((prev) => ({
              ...prev,
              brandId: selectedBrand.id.toString(),
            }));

            if (modelSlug) {
              console.log(`üîç Looking for model: ${modelSlug}`);
              setLoadingModels(true);
              const modelResponse = await apiClient.get(
                `/brands/${selectedBrand.id}/models`
              );
              const brandModels = modelResponse.data as Model[];
              setModels(brandModels);

              const selectedModel = brandModels.find(
                (m: Model) => m.slug === modelSlug
              );
              if (selectedModel) {
                console.log(
                  `‚úÖ Model found: ${selectedModel.name} (ID: ${selectedModel.id})`
                );
                setFormData((prev) => ({
                  ...prev,
                  modelId: selectedModel.id.toString(),
                }));

                if (variantSlug) {
                  console.log(`üîç Looking for variant: ${variantSlug}`);
                  setLoadingVariants(true);
                  const variantResponse = await apiClient.get(
                    `/models/${selectedModel.id}/variants`
                  );
                  const modelVariants = variantResponse.data as Variant[];
                  setVariants(modelVariants);

                  const selectedVariant = modelVariants.find(
                    (v: Variant) => v.slug === variantSlug
                  );
                  if (selectedVariant) {
                    console.log(
                      `‚úÖ Variant found: ${selectedVariant.name} (ID: ${selectedVariant.id})`
                    );
                    setFormData((prev) => ({
                      ...prev,
                      variantId: selectedVariant.id.toString(),
                    }));
                  } else {
                    console.log(`‚ùå Variant not found: ${variantSlug}`);
                  }
                  setLoadingVariants(false);
                } else {
                  console.log("‚ÑπÔ∏è No variantSlug provided");
                }
              } else {
                console.log(`‚ùå Model not found: ${modelSlug}`);
              }
              setLoadingModels(false);
            } else {
              console.log("‚ÑπÔ∏è No modelSlug provided");
            }
          } else {
            console.log(`‚ùå Brand not found: ${brandSlug}`);
          }
          setLoadingBrands(false);
        } else {
          console.log("‚ÑπÔ∏è No brandSlug provided - normal form mode");
        }
      } catch (error) {
        console.error("‚ùå Error loading brand/model/variant data:", error);
        setLoadingBrands(false);
        setLoadingModels(false);
        setLoadingVariants(false);
      }
    };

    loadFromSlugs();
  }, [brandSlug, modelSlug, variantSlug]);

  // Load brands on component mount
  useEffect(() => {
    const loadBrands = async () => {
      console.log("üîÑ PilotForm Loading brands...");
      setLoadingBrands(true);
      try {
        const response = await apiClient.get("/brands");
        const brandsData = response.data as Brand[];
        setBrands(brandsData);
        console.log(
          `‚úÖ ${brandsData.length} marka y√ºklendi:`,
          brandsData.map((b) => b.name)
        );
      } catch (error) {
        console.error("‚ùå Brands loading error:", error);
      } finally {
        setLoadingBrands(false);
      }
    };

    loadBrands();
  }, []);

  // Kullanƒ±cƒ± bilgilerini y√ºkle
  useEffect(() => {
    if (user) {
      setFormData((prev) => ({
        ...prev,
        sellerName: `${user.firstName} ${user.lastName}`,
        sellerPhone: user.phone || "",
        sellerEmail: user.email || "",
        city: user.city || "",
        district: "",
      }));
    }
  }, [user]);

  // ≈ûehirler y√ºkle
  useEffect(() => {
    const loadCities = async () => {
      setLoadingCities(true);
      try {
        const response = await apiClient.get("/cities");
        setCities(response.data as City[]);
      } catch (err) {
        console.error("≈ûehirler y√ºklenirken hata:", err);
        setError("≈ûehirler y√ºklenirken hata olu≈ütu");
      } finally {
        setLoadingCities(false);
      }
    };
    loadCities();
  }, []);

  const handleCityChange = async (cityName: string) => {
    setFormData((prev) => ({ ...prev, city: cityName, district: "" }));
    setLoadingDistricts(true);

    try {
      const city = cities.find((c) => c.name === cityName);
      if (city) {
        const response = await apiClient.get(`/cities/${city.id}/districts`);
        setDistricts(response.data as District[]);
      }
    } catch (err) {
      console.error("ƒ∞l√ßeler y√ºklenirken hata:", err);
      setDistricts([]);
      setError("ƒ∞l√ßeler y√ºklenirken hata olu≈ütu");
    } finally {
      setLoadingDistricts(false);
    }
  };

  const formatPrice = (value: string) => {
    const numbers = value.replace(/\D/g, "");
    if (!numbers) return "";
    return new Intl.NumberFormat("tr-TR").format(parseInt(numbers));
  };

  const handlePriceChange = (value: string) => {
    const numbers = value.replace(/\D/g, "");
    setFormData((prev) => ({ ...prev, price: numbers }));
  };

  const handleInputChange = (
    field: keyof PilotFormData,
    value: string | number | boolean
  ) => {
    setFormData((prev) => ({
      ...prev,
      [field]: value,
    }));
  };

  const handleImageUpload = (event: React.ChangeEvent<HTMLInputElement>) => {
    const files = Array.from(event.target.files || []);
    const totalFiles = images.length + files.length;

    if (totalFiles > 10) {
      setError("En fazla 10 fotoƒüraf y√ºkleyebilirsiniz");
      return;
    }

    setImages((prev) => [...prev, ...files]);
    setError(null);
  };

  const removeImage = (index: number) => {
    setImages((prev) => prev.filter((_, i) => i !== index));
    if (showcaseImageIndex >= images.length - 1) {
      setShowcaseImageIndex(Math.max(0, images.length - 2));
    }
  };

  const setShowcaseImage = (index: number) => {
    setShowcaseImageIndex(index);
  };

  const validateStep = (step: number): boolean => {
    switch (step) {
      case 0: // ƒ∞lan Detaylarƒ±
        if (!formData.title.trim()) {
          setError("ƒ∞lan ba≈ülƒ±ƒüƒ± gereklidir");
          return false;
        }
        if (!formData.description.trim()) {
          setError("A√ßƒ±klama gereklidir");
          return false;
        }
        if (
          formData.year < 1980 ||
          formData.year > new Date().getFullYear() + 1
        ) {
          setError("Ge√ßerli bir √ºretim yƒ±lƒ± giriniz");
          return false;
        }
        if (formData.uzunluk <= 0) {
          setError("Uzunluk bilgisi gereklidir");
          return false;
        }
        break;
      case 1: // Fotoƒüraflar
        if (images.length === 0) {
          setError("En az 1 fotoƒüraf y√ºklemeniz gerekli");
          return false;
        }
        break;
      case 2: // ƒ∞leti≈üim & Fiyat
        if (!formData.sellerPhone?.trim()) {
          setError("Telefon numarasƒ± gereklidir");
          return false;
        }
        if (!formData.price.trim()) {
          setError("Fiyat bilgisi gereklidir");
          return false;
        }
        if (!formData.city) {
          setError("≈ûehir se√ßimi gereklidir");
          return false;
        }
        if (!formData.district) {
          setError("ƒ∞l√ße se√ßimi gereklidir");
          return false;
        }
        break;
    }
    setError(null);
    return true;
  };

  const handleNext = () => {
    if (validateStep(activeStep)) {
      setActiveStep((prev) => prev + 1);
    }
  };

  const handleBack = () => {
    setActiveStep((prev) => prev - 1);
  };

  const handleSubmit = async () => {
    if (!validateStep(2)) return;

    setLoading(true);
    try {
      console.log("üöÄ PilotForm submission started", formData);
      const submitData = new FormData();

      // Temel bilgiler
      submitData.append("title", formData.title);
      submitData.append("description", formData.description);
      submitData.append("productionYear", formData.year.toString());

      // Category/Brand/Model/Variant ID'lerini ekle
      submitData.append("categoryId", formData.categoryId);
      submitData.append("brandId", formData.brandId);
      submitData.append("modelId", formData.modelId);
      submitData.append("variantId", formData.variantId || "");

      // Brand/Model/Variant name'lerini ekle (ensureBrandModelVariant i√ßin gerekli)
      const selectedBrand = brands.find(
        (b) => b.id.toString() === formData.brandId
      );
      const selectedModel = models.find(
        (m) => m.id.toString() === formData.modelId
      );
      const selectedVariant = variants.find(
        (v) => v.id.toString() === formData.variantId
      );

      if (selectedBrand) {
        submitData.append("brandName", selectedBrand.name);
        submitData.append("brandSlug", selectedBrand.slug);
      }
      if (selectedModel) {
        submitData.append("modelName", selectedModel.name);
        submitData.append("modelSlug", selectedModel.slug);
      }
      if (selectedVariant) {
        submitData.append("variantName", selectedVariant.name);
        submitData.append("variantSlug", selectedVariant.slug);
      }

      // URL params'tan gelen slug'larƒ± da ekle
      if (brandSlug && !selectedBrand)
        submitData.append("brandSlug", brandSlug);
      if (modelSlug && !selectedModel)
        submitData.append("modelSlug", modelSlug);
      if (variantSlug && !selectedVariant)
        submitData.append("variantSlug", variantSlug);

      // Year field'ƒ± ekle
      submitData.append("year", formData.year.toString());

      submitData.append("price", formData.price);

      // Pilot √∂zel bilgileri
      submitData.append("uzunluk", formData.uzunluk.toString());
      submitData.append("lastikDurumu", formData.lastikDurumu.toString());
      submitData.append("catiPerdeSistemi", formData.catiPerdeSistemi);

      // Konum
      submitData.append("cityId", formData.cityId || "");
      submitData.append("districtId", formData.districtId || "");
      submitData.append("city", formData.city || "");
      submitData.append("district", formData.district || "");

      // Seller bilgileri (backend'in beklediƒüi field name'ler)
      if (formData.sellerName)
        submitData.append("sellerName", formData.sellerName);
      if (formData.sellerPhone)
        submitData.append("phone", formData.sellerPhone);
      if (formData.sellerEmail)
        submitData.append("email", formData.sellerEmail);

      // Ekstra √∂zellikler
      submitData.append("warranty", formData.warranty ? "evet" : "hayir");
      submitData.append("negotiable", formData.negotiable ? "evet" : "hayir");
      submitData.append("exchange", formData.exchange ? "evet" : "hayir");

      // Detaylƒ± bilgiyi teknik √∂zelliklerle birle≈ütir
      let detailedDescription = formData.detailedInfo;

      // Pilot teknik √∂zellikler eklentisi
      const technicalSpecs = [];
      if (formData.uzunluk)
        technicalSpecs.push(`Uzunluk: ${formData.uzunluk}m`);
      if (formData.lastikDurumu)
        technicalSpecs.push(`Lastik Durumu: ${formData.lastikDurumu}%`);
      if (formData.catiPerdeSistemi)
        technicalSpecs.push(`√áatƒ± Perde Sistemi: ${formData.catiPerdeSistemi}`);

      if (technicalSpecs.length > 0) {
        const techSpecsText =
          "\n\n--- Teknik √ñzellikler ---\n" + technicalSpecs.join("\n");
        detailedDescription = detailedDescription
          ? detailedDescription + techSpecsText
          : techSpecsText;
      }

      submitData.append("detailedInfo", detailedDescription);

      // Fotoƒüraflar
      if (images[showcaseImageIndex]) {
        submitData.append("showcasePhoto", images[showcaseImageIndex]);
      }

      images.forEach((image, index) => {
        submitData.append(`photo_${index}`, image);
      });

      // Video dosyalarƒ±nƒ± ekle
      if (formData.videos && formData.videos.length > 0) {
        console.log(
          `üé• Adding ${formData.videos.length} videos to submit data`
        );
        formData.videos.forEach((video, index) => {
          submitData.append(`video_${index}`, video);
          console.log(`‚úÖ Video ${index + 1} added:`, {
            name: video.name,
            size: video.size,
            type: video.type,
          });
        });
      } else {
        console.log("‚ÑπÔ∏è No videos to add");
      }

      const response = await apiClient.post("/ads/dorse", submitData, {
        headers: {
          "Content-Type": "multipart/form-data",
        },
      });

      console.log("üì§ PilotForm API Response:", response.data);

      const responseData = response.data as {
        success?: boolean;
        id?: string;
        adId?: string;
        message?: string;
      };

      // Backend'den ba≈üarƒ±lƒ± yanƒ±t geldi (200 status code)
      console.log("‚úÖ PilotForm submission successful!");

      // ƒ∞lan ID'sini kaydet (id veya adId field'ƒ±ndan)
      const adId = responseData.id || responseData.adId;
      if (adId) {
        setCreatedAdId(adId);
      }

      setShowSuccessModal(true);
    } catch (err: unknown) {
      console.error("‚ùå PilotForm submission error:", err);
      const error = err as {
        response?: { data?: { message?: string } };
        message?: string;
      };
      setError(
        error.response?.data?.message ||
          error.message ||
          "ƒ∞lan olu≈üturulurken bir hata olu≈ütu"
      );
    } finally {
      setLoading(false);
    }
  };

  // Modal handler fonksiyonlarƒ±
  const handleCloseSuccessModal = () => {
    setShowSuccessModal(false);
    navigate("/"); // Anasayfaya y√∂nlendir
  };

  const handleViewAd = () => {
    if (createdAdId) {
      navigate(`/ads/${createdAdId}`);
    }
  };

  const handleGoHome = () => {
    navigate("/");
  };

  const handleMyAds = () => {
    navigate("/user/my-listings");
  };

  const renderStepContent = (step: number) => {
    switch (step) {
      case 0: // ƒ∞lan Detaylarƒ±
        return (
          <Box sx={{ display: "flex", flexDirection: "column", gap: 3 }}>
            <Typography
              variant="h6"
              sx={{ display: "flex", alignItems: "center", gap: 1 }}
            >
              <Umbrella color="primary" />
              Pilot Tenteli Bilgileri
            </Typography>

            <TextField
              fullWidth
              label="ƒ∞lan Ba≈ülƒ±ƒüƒ±"
              value={formData.title}
              onChange={(e) => handleInputChange("title", e.target.value)}
              placeholder="√ñrn: 2018 Model Pilot Tenteli Dorse"
              required
            />

            <TextField
              fullWidth
              multiline
              rows={4}
              label="A√ßƒ±klama"
              value={formData.description}
              onChange={(e) => handleInputChange("description", e.target.value)}
              placeholder="Pilot tenteli dorsenizin detaylƒ± a√ßƒ±klamasƒ±nƒ± yazƒ±n..."
              required
            />

            <Box
              sx={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 2 }}
            >
              <TextField
                fullWidth
                type="number"
                label="√úretim Yƒ±lƒ±"
                value={formData.year}
                onChange={(e) =>
                  handleInputChange("year", parseInt(e.target.value))
                }
                InputProps={{
                  startAdornment: (
                    <InputAdornment position="start">
                      <DateRange />
                    </InputAdornment>
                  ),
                }}
                inputProps={{
                  min: 1980,
                  max: new Date().getFullYear() + 1,
                }}
                required
              />

              <TextField
                fullWidth
                type="text"
                label="Uzunluk (m)"
                value={formData.uzunluk}
                onChange={(e) => handleInputChange("uzunluk", e.target.value)}
                placeholder="√ñrn: 13.60"
                required
              />
            </Box>

            <Box
              sx={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 2 }}
            >
              <TextField
                fullWidth
                type="number"
                label="Lastik Durumu"
                value={formData.lastikDurumu}
                onChange={(e) =>
                  handleInputChange("lastikDurumu", parseInt(e.target.value))
                }
                InputProps={{
                  endAdornment: (
                    <InputAdornment position="end">%</InputAdornment>
                  ),
                }}
                inputProps={{ min: 0, max: 100 }}
                placeholder="√ñrn: 85"
              />

              <FormControl fullWidth required>
                <InputLabel>√áatƒ± Perde Sistemi</InputLabel>
                <Select
                  value={formData.catiPerdeSistemi}
                  label="√áatƒ± Perde Sistemi"
                  onChange={(e) =>
                    handleInputChange("catiPerdeSistemi", e.target.value)
                  }
                >
                  {CATI_PERDE_SISTEMLERI.map((sistem) => (
                    <MenuItem key={sistem} value={sistem}>
                      {sistem}
                    </MenuItem>
                  ))}
                </Select>
              </FormControl>
            </Box>
          </Box>
        );

      case 1: // Fotoƒüraflar
        return (
          <Box sx={{ display: "flex", flexDirection: "column", gap: 3 }}>
            <Typography
              variant="h6"
              sx={{ display: "flex", alignItems: "center", gap: 1 }}
            >
              <CloudUpload color="primary" />
              Pilot Tenteli Fotoƒüraflarƒ±
            </Typography>

            <Card variant="outlined">
              <CardContent>
                <Box sx={{ textAlign: "center", py: 3 }}>
                  <CloudUpload
                    sx={{ fontSize: 48, color: "text.secondary", mb: 2 }}
                  />
                  <Typography variant="h6" gutterBottom>
                    Pilot Tenteli Fotoƒüraflarƒ±nƒ± Y√ºkleyin
                  </Typography>
                  <Typography
                    variant="body2"
                    color="text.secondary"
                    sx={{ mb: 2 }}
                  >
                    En fazla 10 fotoƒüraf y√ºkleyebilirsiniz. ƒ∞lk fotoƒüraf vitrin
                    fotoƒürafƒ± olacaktƒ±r.
                  </Typography>
                  <input
                    type="file"
                    multiple
                    accept="image/*"
                    onChange={handleImageUpload}
                    style={{ display: "none" }}
                    id="image-upload"
                  />
                  <label htmlFor="image-upload">
                    <Button
                      variant="contained"
                      component="span"
                      startIcon={<CloudUpload />}
                      disabled={images.length >= 10}
                    >
                      Fotoƒüraf Se√ß
                    </Button>
                  </label>
                </Box>
              </CardContent>
            </Card>

            {images.length > 0 && (
              <Box>
                <Typography variant="subtitle2" sx={{ mb: 2 }}>
                  Y√ºklenen Fotoƒüraflar ({images.length}/10)
                </Typography>
                <Box
                  sx={{
                    display: "grid",
                    gridTemplateColumns:
                      "repeat(auto-fill, minmax(150px, 1fr))",
                    gap: 2,
                  }}
                >
                  {images.map((file, index) => (
                    <Card
                      key={index}
                      sx={{
                        position: "relative",
                        border:
                          showcaseImageIndex === index ? "2px solid" : "none",
                        borderColor: "primary.main",
                        cursor: "pointer",
                      }}
                      onClick={() => setShowcaseImage(index)}
                    >
                      <img
                        src={URL.createObjectURL(file)}
                        alt={`Preview ${index + 1}`}
                        style={{
                          width: "100%",
                          height: 120,
                          objectFit: "cover",
                        }}
                      />
                      {showcaseImageIndex === index && (
                        <Box
                          sx={{
                            position: "absolute",
                            top: 4,
                            left: 4,
                            bgcolor: "primary.main",
                            color: "white",
                            px: 1,
                            py: 0.5,
                            borderRadius: 1,
                            fontSize: "0.75rem",
                          }}
                        >
                          Vitrin
                        </Box>
                      )}
                      <IconButton
                        size="small"
                        sx={{
                          position: "absolute",
                          top: 4,
                          right: 4,
                          bgcolor: "rgba(255, 255, 255, 0.8)",
                          "&:hover": { bgcolor: "rgba(255, 255, 255, 0.9)" },
                        }}
                        onClick={(e) => {
                          e.stopPropagation();
                          removeImage(index);
                        }}
                      >
                        <Close fontSize="small" />
                      </IconButton>
                    </Card>
                  ))}
                </Box>
              </Box>
            )}

            {/* Video Upload Section */}
            <Card variant="outlined">
              <CardContent>
                <Box sx={{ textAlign: "center", py: 3 }}>
                  <VideoLibrary
                    sx={{ fontSize: 48, color: "text.secondary", mb: 2 }}
                  />
                  <Typography variant="h6" gutterBottom>
                    Video Y√ºkleyin (Opsiyonel)
                  </Typography>
                  <Typography
                    variant="body2"
                    color="text.secondary"
                    sx={{ mb: 2 }}
                  >
                    En fazla 5 video y√ºkleyebilirsiniz. Video boyutu maksimum
                    50MB olmalƒ±dƒ±r.
                  </Typography>
                  <input
                    type="file"
                    multiple
                    accept="video/*"
                    onChange={handleVideoUpload}
                    style={{ display: "none" }}
                    id="video-upload"
                  />
                  <label htmlFor="video-upload">
                    <Button
                      variant="outlined"
                      component="span"
                      startIcon={<VideoLibrary />}
                      disabled={formData.videos.length >= 5}
                    >
                      Video Se√ß
                    </Button>
                  </label>
                </Box>
              </CardContent>
            </Card>

            {formData.videos.length > 0 && (
              <Box>
                <Typography variant="subtitle2" sx={{ mb: 2 }}>
                  Y√ºklenen Videolar ({formData.videos.length}/5)
                </Typography>
                <Box
                  sx={{
                    display: "grid",
                    gridTemplateColumns:
                      "repeat(auto-fill, minmax(200px, 1fr))",
                    gap: 2,
                  }}
                >
                  {videoPreviews.map((videoUrl, index) => (
                    <Card key={index} sx={{ position: "relative" }}>
                      <video
                        src={videoUrl}
                        style={{
                          width: "100%",
                          height: 120,
                          objectFit: "cover",
                        }}
                        onClick={() => openVideoModal(index)}
                      />
                      <IconButton
                        size="small"
                        sx={{
                          position: "absolute",
                          top: 4,
                          right: 4,
                          bgcolor: "rgba(255, 255, 255, 0.8)",
                          "&:hover": { bgcolor: "rgba(255, 255, 255, 0.9)" },
                        }}
                        onClick={(e) => {
                          e.stopPropagation();
                          removeVideo(index);
                        }}
                      >
                        <Close fontSize="small" />
                      </IconButton>
                      <IconButton
                        size="small"
                        sx={{
                          position: "absolute",
                          bottom: 4,
                          right: 4,
                          bgcolor: "rgba(0, 0, 0, 0.6)",
                          color: "white",
                          "&:hover": { bgcolor: "rgba(0, 0, 0, 0.8)" },
                        }}
                        onClick={() => openVideoModal(index)}
                      >
                        <PlayArrow fontSize="small" />
                      </IconButton>
                    </Card>
                  ))}
                </Box>
              </Box>
            )}
          </Box>
        );

      case 2: // ƒ∞leti≈üim & Fiyat
        return (
          <Box sx={{ display: "flex", flexDirection: "column", gap: 3 }}>
            <Typography
              variant="h6"
              sx={{ display: "flex", alignItems: "center", gap: 1 }}
            >
              <Person color="primary" />
              ƒ∞leti≈üim & Fiyat Bilgileri
            </Typography>

            <Box
              sx={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 2 }}
            >
              <Autocomplete
                options={cities}
                getOptionLabel={(option) => option.name}
                value={
                  cities.find((city) => city.name === formData.city) || null
                }
                onChange={(_, newValue) => {
                  if (newValue) {
                    handleCityChange(newValue.name);
                  }
                }}
                loading={loadingCities}
                renderInput={(params) => (
                  <TextField
                    {...params}
                    label="≈ûehir"
                    required
                    InputProps={{
                      ...params.InputProps,
                      startAdornment: (
                        <InputAdornment position="start">
                          <LocationOn />
                        </InputAdornment>
                      ),
                      endAdornment: (
                        <>
                          {loadingCities ? (
                            <CircularProgress size={20} />
                          ) : null}
                          {params.InputProps.endAdornment}
                        </>
                      ),
                    }}
                  />
                )}
              />

              <Autocomplete
                options={districts}
                getOptionLabel={(option) => option.name}
                value={
                  districts.find(
                    (district) => district.name === formData.district
                  ) || null
                }
                onChange={(_, newValue) => {
                  if (newValue) {
                    handleInputChange("district", newValue.name);
                  }
                }}
                loading={loadingDistricts}
                disabled={!formData.city || loadingDistricts}
                renderInput={(params) => (
                  <TextField
                    {...params}
                    label="ƒ∞l√ße"
                    required
                    InputProps={{
                      ...params.InputProps,
                      startAdornment: (
                        <InputAdornment position="start">
                          <LocationOn />
                        </InputAdornment>
                      ),
                      endAdornment: (
                        <>
                          {loadingDistricts ? (
                            <CircularProgress size={20} />
                          ) : null}
                          {params.InputProps.endAdornment}
                        </>
                      ),
                    }}
                  />
                )}
              />
            </Box>

            <TextField
              fullWidth
              label="Fiyat"
              value={formatPrice(formData.price)}
              onChange={(e) => handlePriceChange(e.target.value)}
              InputProps={{
                startAdornment: (
                  <InputAdornment position="start">
                    <AttachMoney />
                  </InputAdornment>
                ),
                endAdornment: (
                  <InputAdornment position="end">TL</InputAdornment>
                ),
              }}
              placeholder="150.000"
              required
            />

            <Box sx={{ display: "flex", flexDirection: "column", gap: 1 }}>
              <FormControlLabel
                control={
                  <Checkbox
                    checked={formData.negotiable}
                    onChange={(e) =>
                      handleInputChange("negotiable", e.target.checked)
                    }
                  />
                }
                label="Pazarlƒ±k yapƒ±labilir"
              />
              <FormControlLabel
                control={
                  <Checkbox
                    checked={formData.exchange}
                    onChange={(e) =>
                      handleInputChange("exchange", e.target.checked)
                    }
                  />
                }
                label="Takas yapƒ±labilir"
              />
            </Box>
          </Box>
        );

      default:
        return null;
    }
  };

  return (
    <Container maxWidth="lg" sx={{ py: 4 }}>
      <Paper elevation={3} sx={{ p: 4, borderRadius: 2 }}>
        {/* Header */}
        <Box sx={{ mb: 4, textAlign: "center" }}>
          <Typography
            variant="h4"
            component="h1"
            gutterBottom
            sx={{
              fontWeight: "bold",
              background: "linear-gradient(45deg, #2196F3 30%, #21CBF3 90%)",
              WebkitBackgroundClip: "text",
              WebkitTextFillColor: "transparent",
            }}
          >
            Pilot Tenteli ƒ∞lan Ver
          </Typography>
          <Typography variant="body1" color="text.secondary">
            Pilot tenteli dorsenizi kolayca satƒ±≈üa √ßƒ±karƒ±n
          </Typography>
        </Box>

        {/* Stepper */}
        <Stepper activeStep={activeStep} sx={{ mb: 4 }} alternativeLabel>
          {steps.map((label) => (
            <Step key={label}>
              <StepLabel>{label}</StepLabel>
            </Step>
          ))}
        </Stepper>

        {/* Error Alert */}
        {error && (
          <Alert severity="error" sx={{ mb: 3 }} onClose={() => setError(null)}>
            {error}
          </Alert>
        )}

        {/* Step Content */}
        <Box sx={{ mb: 4, minHeight: 400 }}>
          {renderStepContent(activeStep)}
        </Box>

        {/* Navigation Buttons */}
        <Box
          sx={{
            display: "flex",
            justifyContent: "space-between",
            alignItems: "center",
          }}
        >
          <Button
            variant="outlined"
            onClick={handleBack}
            disabled={activeStep === 0 || loading}
            startIcon={<ArrowBack />}
          >
            Geri
          </Button>

          <Typography variant="body2" color="text.secondary">
            Adƒ±m {activeStep + 1} / {steps.length}
          </Typography>

          {activeStep === steps.length - 1 ? (
            <Button
              variant="contained"
              size="large"
              onClick={handleSubmit}
              disabled={loading}
              sx={{ minWidth: 120 }}
            >
              {loading ? <CircularProgress size={24} /> : "ƒ∞lanƒ± Yayƒ±nla"}
            </Button>
          ) : (
            <Button
              variant="contained"
              onClick={handleNext}
              disabled={loading}
              endIcon={<ArrowForward />}
            >
              ƒ∞leri
            </Button>
          )}
        </Box>
      </Paper>

      {/* Video Preview Modal */}
      <Dialog
        open={videoModalOpen}
        onClose={() => setVideoModalOpen(false)}
        maxWidth="md"
        fullWidth
      >
        <DialogTitle>Video √ñnizleme</DialogTitle>
        <DialogContent>
          {videoPreviews[currentVideoIndex] && (
            <video
              src={videoPreviews[currentVideoIndex]}
              controls
              style={{ width: "100%", height: "auto" }}
            />
          )}
        </DialogContent>
        <DialogActions>
          <Button onClick={() => setVideoModalOpen(false)}>Kapat</Button>
        </DialogActions>
      </Dialog>

      {/* Success Modal */}
      <SuccessModal
        open={showSuccessModal}
        onClose={handleCloseSuccessModal}
        title="ƒ∞lan Ba≈üarƒ±yla G√∂nderildi!"
        message="ƒ∞lanƒ±nƒ±z ba≈üarƒ±yla olu≈üturuldu. ‚ö†Ô∏è ƒ∞lanƒ±nƒ±z hen√ºz yayƒ±nda deƒüil! Admin onayƒ± bekliyor."
        adId={createdAdId || undefined}
        onViewAd={createdAdId ? handleViewAd : undefined}
        onGoHome={handleGoHome}
        onMyAds={handleMyAds}
      />
    </Container>
  );
};

export default PilotForm;
